<!DOCTYPE html>
<html lang="en">
	<head>
	<title>MilliMeme | Create and trade dank memes.</title>
	<meta charset='utf-8'>
	<meta name='language' content='EN'>
	<meta name='description'
          content='MilliMeme | Create and trade dank memes.'>
    <meta name='copyright' content='CryptoMilli'>
    <meta property="og:title" content="MilliMeme | Create and trade dank memes."/>
    <meta property="og:description"
          content="MilliMeme | Create and trade dank memes."/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link href="https://fonts.googleapis.com/css?family=Teko" rel="stylesheet">

	<style>
		* {
			font-family: 'Teko', cursive;
		}
		#memeAddress {
			margin: 0 auto;
		}
		.userParams {
			padding-left: 15px;
		}
	</style>

	<script src="static/ipfs.min.js"></script>
	<script language="javascript" type="text/javascript" src="static/jquery.min.js"></script>
	<link rel="stylesheet" href="static/bootstrap.min.css">
	<script src="static/bootstrap.min.js"></script>
	<script src="static/web3.min.js"></script>
	<script type="text/javascript">
		const node = new Ipfs({ host: "ipfs.infura.io", port: 5001, protocol: 'https'});
	</script>
</head>

<body>
	<div class="container">
		<br>
		<div class="inner cover text-center">
            <h1 class="cover-heading"><img src="static/MilliMeme.svg">MilliMeme</h1>
            <p class="lead" style="color:#888;">Create and trade dank memes. (Rinkeby test Network)</p>
        </div>

		<div id="notUsingMetamask" rol="alert"></div>

		<div class="row justify-content-md-center">
			<canvas width="500" height="500"></canvas>
			
			<div class="userParams">
				<div class="form-group">
					<input type="file" id="file" class="btn btn-light">
				</div>
				<div class="form-group">
					<label for="memeName">MEME NAME</label>
					<input id="memeName" type="text" class="form-control" placeholder="Enter name..." required>
				</div>
				<div class="form-group">
					<label for="topText">MEME TOP LINE</label>
					<input id="topText" type="text" class="form-control" placeholder="Enter top line...">
				</div>
				<div class="form-group">
					<label for="bottomText">MEME BOTTOM LINE</label>
					<input id="bottomText" type="text" class="form-control" placeholder="Enter bottom line...">
				</div>
				<button id="saveBtn" class="btn btn-primary btn-lg btn-block">Create Meme</button>
		 	</div>
		</div>

		<br>

		<h2>Dankest Memes</h2>

		<div id="bestMemes">
			<!-- first deck -->
			<div class="card-deck">

			  <!-- card 1 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#modal0">
			    	<img class="card-img-top rounded" id="best0" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="modal0" tabindex="-1" role="dialog" aria-labelledby="modal0Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="card0tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(rankedMemesByBalance[0],$("#card0tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(rankedMemesByBalance[0],$("#card0tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- card 2 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#modal1">
			    	<img class="card-img-top rounded" id="best1" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="modal1" tabindex="-1" role="dialog" aria-labelledby="modal1Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="card1tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(rankedMemesByBalance[1],$("#card1tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(rankedMemesByBalance[1],$("#card1tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- card 3 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#modal2">
			    	<img class="card-img-top rounded" id="best2" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="modal2" tabindex="-1" role="dialog" aria-labelledby="modal2Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="card2tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(rankedMemesByBalance[2],$("#card2tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(rankedMemesByBalance[2],$("#card2tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			</div>

			<!-- Second deck --><br>
			<div class="card-deck">

			  <!-- card 4 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#modal3">
			    	<img class="card-img-top rounded" id="best3" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="modal3" tabindex="-1" role="dialog" aria-labelledby="modal3Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="card3tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(rankedMemesByBalance[3],$("#card3tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(rankedMemesByBalance[3],$("#card3tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- card 5 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#modal4">
			    	<img class="card-img-top rounded" id="best4" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="modal4" tabindex="-1" role="dialog" aria-labelledby="modal4Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="card4tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(rankedMemesByBalance[4],$("#card4tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(rankedMemesByBalance[4],$("#card4tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- card 6 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#modal5">
			    	<img class="card-img-top rounded" id="best5" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="modal5" tabindex="-1" role="dialog" aria-labelledby="modal5Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="card5tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(rankedMemesByBalance[5],$("#card5tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(rankedMemesByBalance[5],$("#card5tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			</div>
			<!-- end of second Best deck -->
		</div>
		<!-- end of Best Memes -->


		
		<br>
		<h2>Latest Memes</h2>

		<!-- Latest Memes -->
		<div id="latestMemes">
			<!-- first Latest deck -->
			<div class="card-deck">

			  <!-- card 1 latest -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#latestM0">
			    	<img class="card-img-top rounded" id="latest0" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="latestM0" tabindex="-1" role="dialog" aria-labelledby="latestM0Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="latest0tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(latestMemes[0],$("#latest0tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(latestMemes[0],$("#latest0tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- latest card 2 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#latestM1">
			    	<img class="card-img-top rounded" id="latest1" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="latestM1" tabindex="-1" role="dialog" aria-labelledby="latestM1Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="latest1tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(latestMemes[1],$("#latest1tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(latestMemes[1],$("#latest1tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- latest card 3 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#latestM2">
			    	<img class="card-img-top rounded" id="latest2" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="latestM2" tabindex="-1" role="dialog" aria-labelledby="latestM2Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="latest2tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(latestMemes[2],$("#latest2tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(latestMemes[2],$("#latest2tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			</div>

			<!-- Second latest deck --><br>
			<div class="card-deck">

			  <!-- latest card 4 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#latestM3">
			    	<img class="card-img-top rounded" id="latest3" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="latestM3" tabindex="-1" role="dialog" aria-labelledby="latestM3Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="latest3tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(latestMemes[3],$("#latest3tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(latestMemes[3],$("#latest3tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- latest card 5 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#latestM4">
			    	<img class="card-img-top rounded" id="latest4" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="latestM4" tabindex="-1" role="dialog" aria-labelledby="latestM4Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="latest4tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(latestMemes[4],$("#latest4tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(latestMemes[4],$("#latest4tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			  <!-- latest card 6 -->
			  <div class="card">
			  	<a data-toggle="modal" data-target="#latestM5">
			    	<img class="card-img-top rounded" id="latest5" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    </a>

			    <div class="modal fade" id="latestM5" tabindex="-1" role="dialog" aria-labelledby="latestM5Label" aria-hidden="true">
				  <div class="modal-dialog" role="document">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
				        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				          <span aria-hidden="true">&times;</span>
				        </button>
				      </div>
				      <div class="modal-body row">
				        <input type="number" class="form-control card-title" id="latest5tokens" placeholder="Enter number of tokens" required>
				      </div>
				      <div class="modal-footer">
				      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint(latestMemes[5],$("#latest5tokens").val())'>Buy</button>
				      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn(latestMemes[5],$("#latest5tokens").val())'>Sell</button>
				      </div>
				    </div>
				  </div>
				</div>
			  </div>

			</div>
			<!-- end of Latest second deck -->
		</div>
		<!-- end of Latest Memes -->


		<br>

		<div class="jumbotron text-center">
			<h2>Trade a Meme</h2>
			<input id="memeAddress" type="text" class="form-control col-md-6 col-md-offset-3 text-center" placeholder="Enter meme's address">
			<br>

			<a data-toggle="modal" data-target="#modal6">
				<img id="memeAddressImg" src="" class="img-fluid rounded">
			</a>

			<div class="modal fade" id="modal6" tabindex="-1" role="dialog" aria-labelledby="modal6Label" aria-hidden="true">
			  <div class="modal-dialog" role="document">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="exampleModalLabel">Eth amount is auto calculated</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
			      </div>
			      <div class="modal-body row">
			        <input type="number" class="form-control card-title" id="card6tokens" placeholder="Enter number of tokens" required>
			      </div>
			      <div class="modal-footer">
			      	<button type="button" class="btn btn-success col align-self-start" data-dismiss="modal" onClick='startApp().mint($("#memeAddress").val(),$("#card6tokens").val())'>Buy</button>
			      	<button type="button" class="btn btn-danger col align-self-end" data-dismiss="modal" onClick='startApp().burn($("#memeAddress").val(),$("#card6tokens").val())'>Sell</button>
			      </div>
			    </div>
			  </div>
			</div>

			<br><br>
			<div id="memeBalance" rol="alert"></div>
			<div id="tokenBalance" rol="alert"></div>

			<!-- Table list of Memes the user owns -->
			<div id="userTokens">
				<button type="button" class="btn btn-dark" onClick="startApp().displayAllUserTokens()">Display all my Meme tokens</button>
			</div>
		</div>

		<!-- contact -->
		<div class="mastfoot text-center">
	        <div class="inner">
	          <p>Built with love <3 by <a target="_blank" href="https://dribbble.com/kimmkim">Kim</a> and <a target="_blank" href="https://twitter.com/mohamedhayibor">Mo</a>.</p>
	        </div>
	    </div>


		<!-- Dimissible transaction confirmation footer alert -->
		<footer id="txStatus" class="fixed-bottom container">
		</footer>

	</div>
	
	<script>
		// web3 init
		window.addEventListener('load', function () {
			// checking if web3 has been injected by the browser
			if (typeof web3 !== 'undefined') {
				// Use Metamask's provider
				web3js = new Web3(web3.currentProvider);
			} else {
				$("#notUsingMetamask").addClass("alert alert-warning")
					.text("Install Metamask in order to use this site :(");
				web3js = new Web3(new Web3.providers.HttpProvider("https://infura.io/"));
			}

			startApp();
		});

		var userLatestImgBase64;
		var allMemes;
		var allUserTokens = {};
		var latestMemes;
		// map 
		var addrToBalances = {};
		var rankedMemesByBalance = [];

		const memeRecorderABI = web3.eth.contract([{"constant":true,"inputs":[],"name":"getMemes","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"memeContracts","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_ipfsHash","type":"string"},{"name":"_name","type":"string"}],"name":"addMeme","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

		const memeABI = web3.eth.contract([{"constant":true,"inputs":[],"name":"creator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"burn","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"tokenBalances","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"getBurningReward","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"poolBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"mint","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"ipfsHash","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"getMintingPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_ipfsHash","type":"string"},{"name":"_creator","type":"address"},{"name":"_name","type":"string"},{"name":"_decimals","type":"uint8"},{"name":"_exponent","type":"uint8"},{"name":"_precision","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

		// main web3 logic
		function startApp() {

			var userAddress = web3js.eth.accounts[0];
			// get all current memes -> allMemes
			getMemes();

			setTimeout(fetchAddrBalances, 2000);
			// display current best performing memes > [Todo: Horrible to fix]
			setTimeout(displayBestMemes, 4000);
			setTimeout(displayLatestMemes, 4500);

			////////////////////////////
			// logic for memeAddress
			////////////////////////////
			$("#memeAddress").on('keyup', function() {
				var memeAddress = $("#memeAddress").val().trim();
		    	if (memeAddress < 40) {
		    		return; // stop everything
		    	}
		    	if (memeAddress.length == 40) memeAddress = "0x" + memeAddress;

		    	let memeInstance = memeABI.at(memeAddress);

		    	memeInstance.ipfsHash.call((err, imgHash) => {
					if (err) {
						console.log("Error: ", err);
					} else {

						node.files.get(imgHash, (err, files) => {
							if (err) {
								console.error(err);
							}

							let selectedMeme = files[0].content;
							document.getElementById("memeAddressImg").src = selectedMeme.toString('utf8');
						});
					}
				});

		    	// retrieve meme balance and totalSupply and display info-alert
		    	memeInstance.poolBalance.call( (err, bal) => {
		    		let balance = Number(bal);

		    		memeInstance.totalSupply.call( (err, supply) => {
		    			let totalSupply = Number(supply);

		    			$("#memeBalance").addClass("alert alert-warning")
		    				.text("Meme balance: " + balance + " (wei) | Total supply: " + totalSupply);
		    		});
		    	});

		    	memeInstance.tokenBalances.call(userAddress, (err, bal) => {
		    		let tokenBalance = Number(bal);

		    		$("#tokenBalance").addClass("alert alert-warning")
		    			.text("You have " + tokenBalance + " tokens on this meme.");
		    	});
		    });


			/////////////////////////////////
			// Smart contract interactions
			/////////////////////////////////
			function addMeme(ipfsHash, name) {
				// hardcoded rinkeby test MemeRecorder contract
				var memeRecorderInstance = memeRecorderABI.at("0xD34b2EC1a74324b38C3305f59455d4813d3cd0B7");

				memeRecorderInstance.addMeme(ipfsHash, name, {from: userAddress}, (err, txHash) => {
					if (err) {
						return error(err);
					}

					document.querySelector("#txStatus").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Your transaction has been broadcasted!</strong>\nTransaction hash: <a target="_blank" href="https://rinkeby.etherscan.io/tx/' + txHash +'">' + txHash + '</a> <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';

					waitConfirmation(txHash, function () {
						document.querySelector("#txStatus").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Successfully added ' + name + ' Meme!</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';

					});
				});
			}

			// See pattern https://programtheblockchain.com/posts/2017/12/13/building-decentralized-apps-with-ethereum-and-javascript/
			function waitConfirmation(hash, cb) {
				web3js.eth.getTransactionReceipt(hash, (err, receipt) => {
					if (err) {
						console.log(err);
					}

					if (receipt !== null) {
						// transaction went through
						if (cb) {
							cb(receipt);
						}
					} else {
						// try again in 1s
						window.setTimeout(function () {
							waitConfirmation(hash, cb);
						}, 1000);
					}
				});
			}

			//////////////////////////////////////
			// Get calls on smart contract >> free
			//////////////////////////////////////
			function getMemes() {
				let memeRecorderInstance = memeRecorderABI.at("0xd34b2ec1a74324b38c3305f59455d4813d3cd0b7");

				memeRecorderInstance.getMemes.call((err, res) => {
					if (err) {
						console.error("Error: ", err);
					} else {
						allMemes = res;
					}
				})
			}

			function getMintingPrice(contractAddress, numTokens) {
				let memeInstance = memeABI.at(contractAddress);
				let price;

				memeInstance.getMintingPrice.call(numTokens, (err, res) => {
					if (err) {
						console.error("Error: ", err);
					} else {
						price = Number(res);
						return price;
					}
				});
			}

			function getBurningReward(contractAddress, numTokens) {
				let memeInstance = memeABI.at(contractAddress);
				let reward;

				memeInstance.getBurningReward.call(numTokens, (err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						reward = Number(res);
						return reward;
					}
				}) 
			}

			/////////////////////////////////////////////////////
			// allMemes -> memeIpfsHash -> ImgFromIpfs -> display
			/////////////////////////////////////////////////////
			function memeIpfsHash(contractAddress, imgId, isLatest) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.ipfsHash.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						// display imgs on page
						imgFromIpfs(res, imgId, isLatest);
						return res;
					}
				})
			}

			function assignBalance(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);
				let balance;
				memeInstance.poolBalance.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						balance = Number(res);
						addrToBalances[contractAddress] = balance;
					}
				});
			}

			async function fetchAddrBalances() {
				const allAddrBalances = allMemes.map(addr => assignBalance(addr));
				await Promise.all(allAddrBalances);
			}

			async function displayBestMemes() {
				let memesToBalance = [];

				for (var addr in addrToBalances) {
					memesToBalance.push([addr, addrToBalances[addr]]);
				}

				memesToBalance.sort((a, b) => {
					return b[1] - a[1];
				});

				// ditch the values > already ranked
				rankedMemesByBalance = memesToBalance.slice(0, 6).map(arr => arr[0]);
				
				const displayRankedMemes = rankedMemesByBalance.map( (memeAddr, imgId) => memeIpfsHash(memeAddr, imgId)); 
				await Promise.all(displayRankedMemes);
			}

			async function displayLatestMemes() {
				let len = allMemes.length;
				latestMemes = allMemes.slice(len - 6).reverse();

				let displayCards = latestMemes.map( (memeAddr, imgId) => memeIpfsHash(memeAddr, imgId, true));
				await Promise.all(displayCards);
			}

			function memeBalance(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);
				let balance;
				memeInstance.poolBalance.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						balance = Number(res);
						return balance;
					}
				});
			}

			function memeTotalSupply(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);
				let totalSupply;

				memeInstance.totalSupply.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						totalSupply = Number(res);
						return totalSupply;
					}
				});
			}

			// assumption [from] sender
			function tokenBalance(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);
				let balance;

				memeInstance.tokenBalances.call(userAddress, (err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						balance = Number(res);
						return balance;
					}
				});
			}

			////////////////////////////////////
			// mutating contract calls
			// 
			// mint -> valueSent == getMintingPice(numTokens)
			////////////////////////////////////
			function mint(contractAddress, numTokens) {
				if (numTokens == 0) {
					return;
				}

				let memeInstance = memeABI.at(contractAddress);
				let price;

				memeInstance.getMintingPrice.call(numTokens, (err, res) => {
					if (err) {
						console.error("Error: ", err);
					} else {
						price = Number(res);

						memeInstance.mint(numTokens, {from: userAddress, value: price}, (err, txHash) => {
							if (err) {
								return error(err);
							}

							document.querySelector("#txStatus").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Your transaction has been broadcasted!</strong> Transaction hash: <a target="_blank" href="https://rinkeby.etherscan.io/tx/' + txHash +'">' + txHash + '</a><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';

							waitConfirmation(txHash, function() {
								document.querySelector("#txStatus").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Successfully bought ' + numTokens + ' meme tokens!</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';
							});
						});
					}
				});
			}

			function burn(contractAddress, numTokens) {
				if (numTokens == 0) {
					return;
				}

				let memeInstance = memeABI.at(contractAddress);
				let burnReward;

				memeInstance.getBurningReward.call(numTokens, (err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						burnReward = Number(res);
					
						memeInstance.burn(numTokens, {from: userAddress}, (err, txHash) => {
							if (err) {
								return error(err);
							}

							document.querySelector("#txStatus").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Your transaction has been broadcasted!</strong> Transaction hash: <a target="_blank" href="https://rinkeby.etherscan.io/tx/' + txHash +'">' + txHash + '</a><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';

							waitConfirmation(txHash, function() {
								document.querySelector("#txStatus").innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><strong>Successfully burned ' + numTokens + ' meme tokens!</strong><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';
							});
						});	
					}
				});
			}

			/////////////////////////
			// allMemes -> fetchUserTokens -> 2d Array -> filter -> insert html
			/////////////////////////

			function fetchUserTokenBalances() {
				allMemes.map(memeContract => {
					let memeInstanceT = memeABI.at(memeContract);

					memeInstanceT.tokenBalances.call(userAddress, (err, res) => {
						if (err) {
							console.log("Error: ", err);
						} else {
							allUserTokens[memeContract] = Number(res);
						}
					});
				});
			}

			function displayAllUserTokens() {
				fetchUserTokenBalances();
				console.log(">>>> Kicked fetch user tokenBalances")

				// async await is jumbledup in my peabrain head, so fuck it
				setTimeout(function() {

					console.log(">>>> allUserTokens: ", allUserTokens);

					let userTokens2dArray = [];

					// assumption all userTokens already fetched
					for (let memeContract in allUserTokens) {
						userTokens2dArray.push([memeContract, allUserTokens[memeContract]]);
					}

					// filter out 0 balances then sort
					let userMemeTokens2dArray = userTokens2dArray.filter(meme => meme[1] > 0).sort((a, b) => b[1] - a[1]);

					console.log(">>>> userMemeTokens2dArray: ", userMemeTokens2dArray);

					// userTokens div id > build the whole html then shove it in the page 
					let domTableHeader = `<table class="table table-hover">
											  <thead>
											    <tr>
											      <th scope="col">Meme Address</th>
											      <th scope="col">Number of Tokens</th>
											    </tr>
											  </thead>
											  <tbody>`;

					userMemeTokens2dArray.forEach(memeToken => {
						let row = `<tr>
									<td>${memeToken[0]}</td>
									<td>${memeToken[1]}</td>
								  </tr>`;
						domTableHeader += row;
					});

					domTableHeader += "</tbody></table>"

					document.querySelector("#userTokens").innerHTML = domTableHeader;

				}, 1000);
			}

			// getters
			return {
				userAddress,
				getMemes,
				addMeme,
				getMintingPrice,
				getBurningReward,
				memeIpfsHash,
				fetchAddrBalances,
				displayBestMemes,
				memeBalance,
				memeTotalSupply,
				tokenBalance,
				mint,
				burn,
				fetchUserTokenBalances,
				displayAllUserTokens
			}

		}

		function imgFromIpfs(imgHash, imgId, isLatest) {

			node.files.get(imgHash, (err, files) => {
				if (err) {
					console.error(err);
				}

				files.forEach((file) => {
					let domNode;

					if (isLatest) {
						domNode = document.getElementById(`latest${imgId}`);
					} else {
						domNode = document.getElementById(`best${imgId}`);
					}

					domNode.src = file.content.toString('utf8');
				});
			});
		}

		function textChangeListener (evt) {
			var id = evt.target.id;
			var text = evt.target.value;

			if (id == "topText") {
				window.topText = text;
			} else {
				window.bottomText = text;
			}

			redrawMeme(window.imageSrc, window.topText, window.bottomText);
		}

		function redrawMeme(image, topLine, bottomLine) {

			if (image != null) ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

			ctx.font = "30pt Impact";
			ctx.textAlign = "center";
			ctx.strokeStyle = "black";
			ctx.lineWidth = "3";
			ctx.fillStyle = "white";

			if (topLine != null) {
				ctx.fillText(topLine, canvas.width / 2, 80);
				ctx.strokeText(topLine, canvas.width / 2, 80);
			}

			if (bottomLine != null) {
				ctx.fillText(bottomLine, canvas.width / 2, canvas.height - 40);
				ctx.strokeText(bottomLine, canvas.width / 2, canvas.height - 40);
			}

			userLatestImgBase64 = document.querySelector('canvas').toDataURL();
		}

		function saveImg(evt) {
			var userImgBuffer = new node.types.Buffer(userLatestImgBase64);
			var memeName = $("#memeName").val().trim();

			node.files.add(userImgBuffer, (err, res) => {
				if (err) {
					console.error(err);
				}

				let ipfsHash = res[0].hash;

				let url = `https://ipfs.io/ipfs/${ipfsHash}`;

				// addMeme on MemeRecorder
				startApp().addMeme(ipfsHash, memeName);
			});
		}

		function handleFileSelect(evt) {
			var canvasWidth = 500;
			var canvasHeight = 500;
			var file = evt.target.files[0];

			var reader = new FileReader();

			reader.onload = function(fileObject) {
				var data = fileObject.target.result;

				// create an image object
				var image = new Image();

				image.onload = function () {
					window.imageSrc = this;
					redrawMeme(window.imageSrc, null, null);
				}

				// Set image data background image
				image.src = data;
			};

			reader.readAsDataURL(file);
		}

		// danger zone globals :(
		window.topText = "";
		window.bottomText = "";
		var input1 = document.getElementById("topText");
		var input2 = document.getElementById("bottomText");
		input1.oninput = textChangeListener;
		input2.oninput = textChangeListener;
		document.getElementById("file").addEventListener("change", handleFileSelect, false);
		document.querySelector("button").addEventListener("click", saveImg, false);

		var canvas = document.querySelector('canvas');
		var ctx = canvas.getContext("2d");

		//////////////
		// initial 2 squares art + upload an image
		//////////////
		
		// red
		ctx.fillStyle = 'rgb(200, 0, 0)';
        ctx.fillRect(50, 50, 300, 300);
        //violet
        ctx.fillStyle = 'rgba(0, 0, 200, 0.5)';
        ctx.fillRect(150, 150, 300, 300);

        ctx.textAlign = "center";
        ctx.font = "30pt Impact";
		ctx.strokeText('Upload an image', 200, 300);
	</script>
</body>
</html>
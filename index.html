<!DOCTYPE html>
<html>
	<head>
	<title>Meme - Simple</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<style>
		#image-container {
			display: flex;
		}
	</style>

	<script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
	<script type="text/javascript">
		const node = new Ipfs({ repo: 'ipfs-' + Math.random() })
	</script>
</head>

<body>
	<div>
		<h4>Testing img</h4>
		<img id="imgtest" src="">
	</div>

	<div>
		<input type="file" id="file">
	</div>

	<div id="image-container">
		<canvas width="500" height="500"></canvas>
		<div>
			<span>Top Line:</span><br>
			<input id="topText" type="text"><br>
			<span>Bottom Line:</span><br>
			<input id="bottomText" type="text"><br>
			<button id="saveBtn">Save</button>
		</div>
	</div>
	<script>
		var userLatestImgBase64;

		function imgRetrievalTest(imgHash) {
			node.files.get(imgHash, (err, files) => {
				files.forEach((file) => {
					console.log("File path: ", file.path);
					console.log(">> File content: ", file.content.toString('utf8'));

					// Test displaying img
					document.getElementById("imgtest").src = file.content.toString('utf8');
				});
			});
		}

		function textChangeListener (evt) {
			var id = evt.target.id;
			var text = evt.target.value;

			if (id == "topText") {
				window.topText = text;
			} else {
				window.bottomText = text;
			}

			redrawMeme(window.imageSrc, window.topText, window.bottomText);
		}

		function redrawMeme(image, topLine, bottomLine) {
			var canvas = document.querySelector('canvas');
			var ctx = canvas.getContext("2d");

			if (image != null) ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

			ctx.font = "30pt Impact";
			ctx.textAlign = "center";
			ctx.strokeStyle = "black";
			ctx.lineWidth = "3";
			ctx.fillStyle = "white";

			if (topLine != null) {
				ctx.fillText(topLine, canvas.width / 2, 40);
				ctx.strokeText(topLine, canvas.width / 2, 40);
			}

			if (bottomLine != null) {
				ctx.fillText(bottomLine, canvas.width / 2, canvas.height - 40);
				ctx.strokeText(bottomLine, canvas.width / 2, canvas.height - 40);
			}

			// .slice(23)
			userLatestImgBase64 = document.querySelector('canvas').toDataURL();
			console.log("userLatestImgBase64: ", userLatestImgBase64);
		}

		function saveImg(evt) {
			var userImgBuffer = new node.types.Buffer(userLatestImgBase64);

			node.files.add(userImgBuffer, (err, res) => {
				if (err) {
					console.error(err);
				}

				console.log("node buffer: Uint8Array saved into ipfs: ", res);

				let url = `https://ipfs.io/ipfs/${res[0].hash}`;
				console.log("> >> > Link retrieval -----------");
				console.log("link: ", url);
			});
		}

		function handleFileSelect(evt) {
			var canvasWidth = 500;
			var canvasHeight = 500;
			var file = evt.target.files[0];

			var reader = new FileReader();

			reader.onload = function(fileObject) {
				var data = fileObject.target.result;

				// create an image object
				var image = new Image();

				image.onload = function () {
					window.imageSrc = this;
					redrawMeme(window.imageSrc, null, null);
				}

				// Set image data background image
				image.src = data;
			};

			reader.readAsDataURL(file);
		}

		window.topText = "";
		window.bottomText = "";
		var input1 = document.getElementById("topText");
		var input2 = document.getElementById("bottomText");
		input1.oninput = textChangeListener;
		input2.oninput = textChangeListener;
		document.getElementById("file").addEventListener("change", handleFileSelect, false);
		document.querySelector("button").addEventListener("click", saveImg, false);
	</script>
</body>
</html>
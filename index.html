<!DOCTYPE html>
<html>
	<head>
	<title>Meme - Simple</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<style>
		#image-container {
			display: flex;
		}
	</style>

	<script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
	<script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
	<script type="text/javascript">
		const node = new Ipfs({ host: "ipfs.infura.io", port: 5001, protocol: 'https'})
	</script>
</head>

<body>
	<div>
		<h4>Testing img</h4>
		<img id="imgtest" src="">
	</div>

	<div>
		<input type="file" id="file">
	</div>

	<div id="image-container">
		<canvas width="500" height="500"></canvas>
		<div>
			<input id="memeName" type="text" class="form-control" placeholder="Enter meme's name..."><br>
			<input id="topText" type="text" class="form-control" placeholder="Enter your top line..."><br>
			<input id="bottomText" type="text" class="form-control" placeholder="Enter your bottom line..."><br>
			<button id="saveBtn">Save</button>
		</div>
	</div>
	<script>
		var userLatestImgBase64;

		// main web3 logic
		function startApp() {
			var memeRecorderABI = web3.eth.contract([{"constant":true,"inputs":[],"name":"getMemes","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"memeContracts","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_ipfsHash","type":"string"},{"name":"_name","type":"string"}],"name":"addMeme","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

			var memeABI = web3.eth.contract([{"constant":true,"inputs":[],"name":"creator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"burn","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"tokenBalances","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"getBurningReward","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"poolBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"mint","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"ipfsHash","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"getMintingPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_ipfsHash","type":"string"},{"name":"_creator","type":"address"},{"name":"_name","type":"string"},{"name":"_decimals","type":"uint8"},{"name":"_exponent","type":"uint8"},{"name":"_precision","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

			var userAddress = web3js.eth.accounts[0];


		}

		function imgRetrievalTest(imgHash) {
			node.files.get(imgHash, (err, files) => {
				files.forEach((file) => {
					console.log("File path: ", file.path);
					console.log(">> File content: ", file.content.toString('utf8'));

					// Test displaying img
					document.getElementById("imgtest").src = file.content.toString('utf8');
				});
			});
		}

		function textChangeListener (evt) {
			var id = evt.target.id;
			var text = evt.target.value;

			if (id == "topText") {
				window.topText = text;
			} else {
				window.bottomText = text;
			}

			redrawMeme(window.imageSrc, window.topText, window.bottomText);
		}

		function redrawMeme(image, topLine, bottomLine) {
			var canvas = document.querySelector('canvas');
			var ctx = canvas.getContext("2d");

			if (image != null) ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

			ctx.font = "30pt Impact";
			ctx.textAlign = "center";
			ctx.strokeStyle = "black";
			ctx.lineWidth = "3";
			ctx.fillStyle = "white";

			if (topLine != null) {
				ctx.fillText(topLine, canvas.width / 2, 80);
				ctx.strokeText(topLine, canvas.width / 2, 80);
			}

			if (bottomLine != null) {
				ctx.fillText(bottomLine, canvas.width / 2, canvas.height - 40);
				ctx.strokeText(bottomLine, canvas.width / 2, canvas.height - 40);
			}

			// .slice(23)
			userLatestImgBase64 = document.querySelector('canvas').toDataURL();
			console.log("userLatestImgBase64: ", userLatestImgBase64);
		}

		function saveImg(evt) {
			var userImgBuffer = new node.types.Buffer(userLatestImgBase64);

			node.files.add(userImgBuffer, (err, res) => {
				if (err) {
					console.error(err);
				}

				console.log("node buffer: Uint8Array saved into ipfs: ", res);

				let url = `https://ipfs.io/ipfs/${res[0].hash}`;
				console.log("> >> > Link retrieval -----------");
				console.log("link: ", url);
			});
		}

		function handleFileSelect(evt) {
			var canvasWidth = 500;
			var canvasHeight = 500;
			var file = evt.target.files[0];

			var reader = new FileReader();

			reader.onload = function(fileObject) {
				var data = fileObject.target.result;

				// create an image object
				var image = new Image();

				image.onload = function () {
					window.imageSrc = this;
					redrawMeme(window.imageSrc, null, null);
				}

				// Set image data background image
				image.src = data;
			};

			reader.readAsDataURL(file);
		}

		window.topText = "";
		window.bottomText = "";
		var input1 = document.getElementById("topText");
		var input2 = document.getElementById("bottomText");
		input1.oninput = textChangeListener;
		input2.oninput = textChangeListener;
		document.getElementById("file").addEventListener("change", handleFileSelect, false);
		document.querySelector("button").addEventListener("click", saveImg, false);

		// web3 init
		window.addEventListener('load', function () {
			// checking if web3 has been injected by the browser
			if (typeof web3 !== 'undefined') {
				// Use Metamask's provider
				web3js = new Web3(web3.currentProvider);
			} else {
				console.log("No web3, try installing Metamask");
				web3js = new Web3(new Web3.providers.HttpProvider("https://infura.io/"));
			}

			startApp();
		});
	</script>
</body>
</html>
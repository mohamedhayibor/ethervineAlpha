<!DOCTYPE html>
<html>
	<head>
	<title>Meme - Simple</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<style>
		#image-container {
			display: flex;
		}
	</style>

	<script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
	<script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
	<script type="text/javascript">
		const node = new Ipfs({ host: "ipfs.infura.io", port: 5001, protocol: 'https'})
	</script>
</head>

<body>
	<div class="container">
		<!-- Todo: Create better jumbotron with fading image memes later
		<div class="jumbotron text-center">	
			<h1>EtherVine</h1>
			<p class="lead" style="color:#888;">Create your meme and trade its tokens on the Ethereum blockchain.</p>
		</div> -->
		<br>

		<div class="row justify-content-md-center">
			<canvas width="500" height="500"></canvas>
			
			<div class="userParams">
				<input type="file" id="file" class="btn btn-light">
				<input id="memeName" type="text" class="form-control" placeholder="Enter name..." required><br>
				<input id="topText" type="text" class="form-control" placeholder="Enter top line..."><br>
				<input id="bottomText" type="text" class="form-control" placeholder="Enter bottom line..."><br>
				<button id="saveBtn" class="btn btn-success">Create Meme</button>
		 	</div>
		</div>

		<br>

		<div id="bestMemes">
			<!-- first deck -->
			<div class="card-deck">
			  <div class="card">
			    <img class="card-img-top" id="best0" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    <div class="card-body row">
			      <button type="button" class="btn btn-success col align-self-start">Mint</button>
			      <button type="button" class="btn btn-danger col align-self-end">Burn</button>
			    </div>
			  </div>
			  <div class="card">
			    <img class="card-img-top" id="best1" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    <div class="card-body">
			      <button type="button" class="btn btn-success">Mint</button>
			      <button type="button" class="btn btn-danger">Burn</button>
			    </div>
			  </div>
			  <div class="card">
			    <img class="card-img-top" id="best2" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    <div class="card-body">
			      <button type="button" class="btn btn-success">Mint</button>
			      <button type="button" class="btn btn-danger">Burn</button>
			    </div>
			  </div>
			</div>
			<!-- Second deck --><br>
			<div class="card-deck">
			  <div class="card">
			    <img class="card-img-top" id="best3" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    <div class="card-body">
			      <button type="button" class="btn btn-success">Mint</button>
			      <button type="button" class="btn btn-danger">Burn</button>
			    </div>
			  </div>
			  <div class="card">
			    <img class="card-img-top" id="best4" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    <div class="card-body">
			      <button type="button" class="btn btn-success">Mint</button>
			      <button type="button" class="btn btn-danger">Burn</button>
			    </div>
			  </div>
			  <div class="card">
			    <img class="card-img-top" id="best5" src="https://static-cdn.jtvnw.net/jtv_user_pictures/e91a3dcf-c15a-441a-b369-996922364cdc-profile_image-300x300.png" alt="Card image cap">
			    <div class="card-body">
			      <button type="button" class="btn btn-success">Mint</button>
			      <button type="button" class="btn btn-danger">Burn</button>
			    </div>
			  </div>
			</div>
		</div>
	</div>

	<script>
		var userLatestImgBase64;
		var allMemes;

		const memeRecorderABI = web3.eth.contract([{"constant":true,"inputs":[],"name":"getMemes","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"memeContracts","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_ipfsHash","type":"string"},{"name":"_name","type":"string"}],"name":"addMeme","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

		const memeABI = web3.eth.contract([{"constant":true,"inputs":[],"name":"creator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"burn","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"tokenBalances","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"getBurningReward","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"poolBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"mint","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"ipfsHash","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_numTokens","type":"uint256"}],"name":"getMintingPrice","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_ipfsHash","type":"string"},{"name":"_creator","type":"address"},{"name":"_name","type":"string"},{"name":"_decimals","type":"uint8"},{"name":"_exponent","type":"uint8"},{"name":"_precision","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

		// main web3 logic
		function startApp() {

			var userAddress = web3js.eth.accounts[0];
			// get all current memes -> allMemes
			getMemes();
			// display current best performing memes > [Todo: Horrible to fix]
			setTimeout(displayBestMemes, 4000);

			function addMeme(ipfsHash, name) {
				// hardcoded rinkeby test MemeRecorder contract
				var memeRecorderInstance = memeRecorderABI.at("0xb93eddce16ae43790eafd7ebee8a5bcf40f46bb5");

				memeRecorderInstance.addMeme(ipfsHash, name, {from: userAddress}, (err, hash) => {
					if (err) {
						return error(err);
					}

					waitConfirmation(hash, function () {
						console.log("Successfully added the Meme.");
					});
				});
			}

			// See pattern https://programtheblockchain.com/posts/2017/12/13/building-decentralized-apps-with-ethereum-and-javascript/
			function waitConfirmation(hash, cb) {
				web3js.eth.getTransactionReceipt(hash, (err, receipt) => {
					if (err) {
						console.log(err);
					}

					if (receipt !== null) {
						// transaction went through
						if (cb) {
							cb(receipt);
						}
					} else {
						// try again in 1s
						window.setTimeout(function () {
							waitConfirmation(hash, cb);
						}, 1000);
					}
				});
			}

			//////////////////////////////////////
			// Get calls on smart contract >> free
			//////////////////////////////////////
			function getMemes() {
				let memeRecorderInstance = memeRecorderABI.at("0xb93eddce16ae43790eafd7ebee8a5bcf40f46bb5");

				memeRecorderInstance.getMemes.call((err, res) => {
					if (err) {
						console.error("Error: ", err);
					} else {
						allMemes = res;
					}
				})
			}

			function getMintingPrice(contractAddress, numTokens) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.getMintingPrice.call(numTokens, (err, res) => {
					if (err) {
						console.error("Error: ", err);
					} else {
						return res;
					}
				});
			}

			function getBurningReward(contractAddress, numTokens) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.getBurningReward.call(numTokens, (err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						return res;
					}
				}) 
			}

			/////////////////////////////////////////////////////
			// allMemes -> memeIpfsHash -> ImgFromIpfs -> display
			/////////////////////////////////////////////////////
			function memeIpfsHash(contractAddress, imgId) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.ipfsHash.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						// display imgs on page
						console.log(" -==--- memeIpfsHash ----==- ");
						console.log(`imh: ${res}, id: ${imgId}`);
						imgFromIpfs(res, imgId);
						// imgFromIpfs
						return res;
					}
				})
			}

			async function displayBestMemes() {
				// for now let's assume the first memes are the most popular
				const allIpfsHashes = allMemes.map( (memeAddr, imgId) => memeIpfsHash(memeAddr, imgId)); 
				const receivedIpfsHashes = await Promise.all(allIpfsHashes);

				console.log("receivedIpfsHashes: ", receivedIpfsHashes);
			}

			function memeBalance(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.poolBalance.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						return res;
					}
				});
			}

			function memeTotalSupply(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.totalSupply.call((err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						return res;
					}
				});
			}

			// assumption for sender
			function tokenBalance(contractAddress) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.tokenBalances.call(userAddress, (err, res) => {
					if (err) {
						console.log("Error: ", err);
					} else {
						return res;
					}
				});
			}

			////////////////////////////////////
			// mutating contract calls
			////////////////////////////////////
			function mint(contractAddress, numTokens, valueSent) {
				let memeInstance = memeABI.at(contractAddress);
				let ethSent = (10 ** 18) * valueSent;

				memeInstance.mint(numTokens, {from: userAddress, value: ethSent}, (err, res) => {
					if (err) {
						return error(err);
					}

					waitConfirmation(hash, function() {
						console.log("Successfully bought " + numTokens + " meme tokens.");
					});
				});
			}

			function burn(contractAddress, numTokens) {
				let memeInstance = memeABI.at(contractAddress);

				memeInstance.burn(numTokens, {from: userAddress}, (err, res) => {
					if (err) {
						return error(err);
					}

					waitConfirmation(hash, function() {
						console.log("Successfully burned " + numTokens + " meme tokens.");
					});
				});
			}


			// getters
			return {
				getMemes,
				addMeme,
				getMintingPrice,
				getBurningReward,
				memeIpfsHash,
				displayBestMemes,
				memeBalance,
				memeTotalSupply,
				tokenBalance,
				mint,
				burn
			}

		}

		function imgFromIpfs(imgHash, imgId) {
			node.files.get(imgHash, (err, files) => {
				files.forEach((file) => {
					console.log("File path: ", file.path);
					console.log(">> File content: ", file.content.toString('utf8'));

					// Test displaying img
					document.getElementById(`best${imgId}`).src = file.content.toString('utf8');
				});
			});
		}

		function textChangeListener (evt) {
			var id = evt.target.id;
			var text = evt.target.value;

			if (id == "topText") {
				window.topText = text;
			} else {
				window.bottomText = text;
			}

			redrawMeme(window.imageSrc, window.topText, window.bottomText);
		}

		function redrawMeme(image, topLine, bottomLine) {

			if (image != null) ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

			ctx.font = "30pt Impact";
			ctx.textAlign = "center";
			ctx.strokeStyle = "black";
			ctx.lineWidth = "3";
			ctx.fillStyle = "white";

			if (topLine != null) {
				ctx.fillText(topLine, canvas.width / 2, 80);
				ctx.strokeText(topLine, canvas.width / 2, 80);
			}

			if (bottomLine != null) {
				ctx.fillText(bottomLine, canvas.width / 2, canvas.height - 40);
				ctx.strokeText(bottomLine, canvas.width / 2, canvas.height - 40);
			}

			userLatestImgBase64 = document.querySelector('canvas').toDataURL();
			console.log("userLatestImgBase64: ", userLatestImgBase64);
		}

		function saveImg(evt) {
			var userImgBuffer = new node.types.Buffer(userLatestImgBase64);
			var memeName = $("#memeName").val().trim();

			node.files.add(userImgBuffer, (err, res) => {
				if (err) {
					console.error(err);
				}

				console.log("node buffer: Uint8Array saved into ipfs: ", res);

				let ipfsHash = res[0].hash;

				let url = `https://ipfs.io/ipfs/${ipfsHash}`;
				console.log("link: ", url);

				// addMeme on MemeRecorder
				startApp().addMeme(ipfsHash, memeName);
			});
		}

		function handleFileSelect(evt) {
			var canvasWidth = 500;
			var canvasHeight = 500;
			var file = evt.target.files[0];

			var reader = new FileReader();

			reader.onload = function(fileObject) {
				var data = fileObject.target.result;

				// create an image object
				var image = new Image();

				image.onload = function () {
					window.imageSrc = this;
					redrawMeme(window.imageSrc, null, null);
				}

				// Set image data background image
				image.src = data;
			};

			reader.readAsDataURL(file);
		}

		// danger zone globals :(
		window.topText = "";
		window.bottomText = "";
		var input1 = document.getElementById("topText");
		var input2 = document.getElementById("bottomText");
		input1.oninput = textChangeListener;
		input2.oninput = textChangeListener;
		document.getElementById("file").addEventListener("change", handleFileSelect, false);
		document.querySelector("button").addEventListener("click", saveImg, false);

		var canvas = document.querySelector('canvas');
		var ctx = canvas.getContext("2d");

		// TODO: fill with a grey preview telling the user to upload an image

		// web3 init
		window.addEventListener('load', function () {
			// checking if web3 has been injected by the browser
			if (typeof web3 !== 'undefined') {
				// Use Metamask's provider
				web3js = new Web3(web3.currentProvider);
			} else {
				console.log("No web3, try installing Metamask");
				web3js = new Web3(new Web3.providers.HttpProvider("https://infura.io/"));
			}

			startApp();
		});
	</script>
</body>
</html>